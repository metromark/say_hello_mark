name: Build and deploy Python package

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write 

jobs:
  pypi-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@main

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::208761073495:role/OneByZeroGithubActions
          aws-region: ap-southeast-1

      - name: Set up Python
        uses: actions/setup-python@v3

      - name: Build
        working-directory: py-api
        run: |
          python3 -m pip install --upgrade build twine
          python3 -m build

      - name: Publish to internal repository
        working-directory: py-api
        run: |
          aws codeartifact login --tool twine --repository pypi_test --domain onebyzero-internal --domain-owner 208761073495 --region us-east-1
          python3 -m twine upload --repository codeartifact dist/* --verbose

      - name: upload windows dist
        # if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: release-dists
          path: py-api/dist


  pypy-publish:
    runs-on: ubuntu-latest
    needs: 
      - pypi-build
    permissions:
      contents: read
      id-token: write
    
    steps:      
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          name: release-dists
          path: py-api/dist
        
      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: py-api/dist

      # - name: Publish to public repository
      #   if: github.ref == 'refs/heads/main'
      #   uses: pypa/gh-action-pypi-publish@release/v1
      #   with:
      #     user: __token__
      #     password: ${{ secrets.PYPI_TOKEN }}
      #     packages-dir: py-api/dist

  npm-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Build
        working-directory: ts-api
        run:  |
          npm install
          npm ci
          npm run build

  publish-internal-npm:
    needs: npm-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::208761073495:role/OneByZeroGithubActions
          aws-region: ap-southeast-1

      - name: Publish to internal repository
        working-directory: ts-api
        run: |
          aws codeartifact login --tool npm --repository npm_test --domain onebyzero-internal --domain-owner 208761073495 --region us-east-1
          npm publish

  publish-external-npm:
    needs: npm-build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org/
      
      - name: Publish to external repo
        working-directory: ts-api
        run: |
          npm ci
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}